name: Generate lock files

on:
  schedule:
    # Every week
    - cron:  '0 14 * * 5'

jobs:
  get_templates:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: cachix/install-nix-action@v15
      with:
        install_url: https://nixos-nix-install-tests.cachix.org/serve/vij683ly7sl95nnhb67bdjjfabclr85m/install
        install_options: '--tarball-url-prefix https://nixos-nix-install-tests.cachix.org/serve'
        extra_nix_config: |
          experimental-features = nix-command flakes
    - name: Inspect the root flake
      id: show-flake
      run: echo "::set-output name=templates::$(nix flake show --json | jq -c '.templates | keys')"
    outputs:
      templates: ${{ steps.show-flake.outputs.templates }}

  check_inputs:
    needs: get_templates
    runs-on: ubuntu-latest
    strategy:
      matrix:
        template: ${{ fromJson(needs.get_templates.outputs.templates) }}
    steps:
    - uses: actions/checkout@v2
    - uses: cachix/install-nix-action@v15
      with:
        install_url: https://nixos-nix-install-tests.cachix.org/serve/vij683ly7sl95nnhb67bdjjfabclr85m/install
        install_options: '--tarball-url-prefix https://nixos-nix-install-tests.cachix.org/serve'
        extra_nix_config: |
          experimental-features = nix-command flakes
    # The template name must be the same as the directory
    - working-directory: ${{ matrix.template }}
      run: nix flake lock
